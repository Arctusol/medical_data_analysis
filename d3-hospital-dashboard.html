<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard d'Analyse Hospitali√®re</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab-content { margin-top: 20px; }
        .chart { height: 400px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center my-4">üè• Dashboard d'Analyse Hospitali√®re</h1>
        
        <div class="row">
            <div class="col-2">
                <div class="card">
                    <div class="card-header">Filtres</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label>Ann√©es</label>
                            <select id="yearSelect" multiple class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label>D√©partements</label>
                            <select id="departmentSelect" multiple class="form-select"></select>
                        </div>
                        <button id="applyFilters" class="btn btn-primary">Appliquer</button>
                    </div>
                </div>
            </div>
            
            <div class="col-10">
                <ul class="nav nav-tabs" id="dashboardTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#generalView">Vue G√©n√©rale</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#geographicView">Analyse G√©ographique</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#pathologyView">Pathologies</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#demographicView">D√©mographie</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="generalView">
                        <div class="row" id="mainMetrics"></div>
                        <div class="row">
                            <div class="col-6 chart" id="hospitalizationTrend"></div>
                            <div class="col-6 chart" id="averageDurationTrend"></div>
                        </div>
                    </div>

                    <div class="tab-pane" id="geographicView">
                        <div class="row">
                            <div class="col-6 chart" id="hospitalByDepartment"></div>
                            <div class="col-6 chart" id="avgDurationByDepartment"></div>
                        </div>
                    </div>

                    <div class="tab-pane" id="pathologyView">
                        <div class="row">
                            <div class="col-12 chart" id="topPathologies"></div>
                            <div class="col-12 chart" id="pathologyDurations"></div>
                        </div>
                    </div>

                    <div class="tab-pane" id="demographicView">
                        <div class="chart" id="ageGroupRecourse"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    class HospitalDashboard {
        constructor() {
            this.data = {
                hospitalizations: null,
                duration: null,
                pathologies: null,
                demographics: null
            };
            this.initGoogleAuth();
        }

        initGoogleAuth() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: 'YOUR_API_KEY', // Replace with actual API key
                    clientId: 'YOUR_CLIENT_ID', // Replace with actual client ID
                    discoveryDocs: ['https://bigquery.googleapis.com/$discovery/rest?version=v2'],
                    scope: 'https://www.googleapis.com/auth/bigquery.readonly'
                }).then(() => {
                    this.loadData();
                });
            });
        }

        async loadData() {
            try {
                // Loading hospitalizations data
                const hospitalizationsQuery = `
                    SELECT year, nom_departement, nbr_hospi 
                    FROM \`projet-jbn-data-le-wagon.morbidite_h.nbr_hospi_intermediate\`
                `;
                const hospitalizations = await this.runBigQueryQuery(hospitalizationsQuery);

                // Loading duration data
                const durationQuery = `
                    SELECT year, nom_departement_region, AVG_duree_hospi 
                    FROM \`projet-jbn-data-le-wagon.duree_hospitalisation_par_patho.duree_hospi_region_et_dpt_clean_classifie\`
                `;
                const duration = await this.runBigQueryQuery(durationQuery);

                // Loading pathologies data
                const pathologiesQuery = `
                    SELECT year, nom_pathologie, nbr_hospi 
                    FROM \`projet-jbn-data-le-wagon.morbidite_h.nbr_hospi_intermediate\`
                `;
                const pathologies = await this.runBigQueryQuery(pathologiesQuery);

                // Loading demographics data
                const demographicsQuery = `
                    SELECT year, tranche_age_1_4, tranche_age_5_14, tranche_age_15_24,
                           tranche_age_25_34, tranche_age_35_44, tranche_age_45_54 
                    FROM \`projet-jbn-data-le-wagon.morbidite_h.tranche_age_intermediate\`
                `;
                const demographics = await this.runBigQueryQuery(demographicsQuery);

                this.data = {
                    hospitalizations,
                    duration,
                    pathologies,
                    demographics
                };

                this.initializeFilters();
                this.renderDashboard();
            } catch (error) {
                console.error("Data loading error:", error);
            }
        }

        async runBigQueryQuery(query) {
            return new Promise((resolve, reject) => {
                gapi.client.bigquery.jobs.query({
                    projectId: 'projet-jbn-data-le-wagon',
                    query: query
                }).then(
                    response => {
                        const rows = response.result.rows.map(row => {
                            const obj = {};
                            response.result.schema.fields.forEach((field, index) => {
                                obj[field.name] = row.f[index].v;
                            });
                            return obj;
                        });
                        resolve(rows);
                    },
                    reason => reject(reason)
                );
            });
        }

        initializeFilters() {
            const years = [...new Set(this.data.hospitalizations.map(d => d.year))];
            const departments = [...new Set(this.data.hospitalizations.map(d => d.nom_departement))];

            const yearSelect = d3.select('#yearSelect')
                .selectAll('option')
                .data(years)
                .enter()
                .append('option')
                .text(d => d)
                .attr('value', d => d);

            const departmentSelect = d3.select('#departmentSelect')
                .selectAll('option')
                .data(departments)
                .enter()
                .append('option')
                .text(d => d)
                .attr('value', d => d);

            d3.select('#applyFilters').on('click', () => this.applyFilters());
        }

        applyFilters() {
            const selectedYears = Array.from(document.getElementById('yearSelect').selectedOptions).map(opt => opt.value);
            const selectedDepartments = Array.from(document.getElementById('departmentSelect').selectedOptions).map(opt => opt.value);

            // Filter data based on selections
            const filteredHospitalizations = this.data.hospitalizations.filter(
                d => selectedYears.includes(d.year) && selectedDepartments.includes(d.nom_departement)
            );

            // Re-render visualizations with filtered data
            this.renderDashboard(filteredHospitalizations);
        }

        renderDashboard(data = this.data.hospitalizations) {
            this.renderMainMetrics(data);
            this.renderHospitalizationTrends(data);
            this.renderGeographicAnalysis(data);
            this.renderPathologyAnalysis(data);
            this.renderDemographicAnalysis(data);
        }

        renderMainMetrics(data) {
            const yearlyTotals = d3.rollups(
                data, 
                v => d3.sum(v, d => +d.nbr_hospi),
                d => d.year
            );

            const metricsContainer = d3.select('#mainMetrics');
            metricsContainer.html(''); // Clear previous metrics

            yearlyTotals.forEach(([year, total]) => {
                metricsContainer.append('div')
                    .attr('class', 'col')
                    .html(`
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Ann√©e ${year}</h5>
                                <p class="card-text">${total.toLocaleString()} hospitalisations</p>
                            </div>
                        </div>
                    `);
            });
        }

        renderHospitalizationTrends(data) {
            const yearlyHospitalizations = d3.rollups(
                data,
                v => d3.sum(v, d => +d.nbr_hospi),
                d => d.year
            );

            const trace = {
                x: yearlyHospitalizations.map(d => d[0]),
                y: yearlyHospitalizations.map(d => d[1]),
                type: 'scatter',
                mode: 'lines+markers'
            };

            Plotly.newPlot('hospitalizationTrend', [trace], {
                title: 'Nombre d\'hospitalisations par ann√©e'
            });
        }

        // Additional rendering methods would follow similar patterns
        renderGeographicAnalysis(data) {
            const hospitalByDepartment = d3.rollups(
                data,
                v => d3.sum(v, d => +d.nbr_hospi),
                d => d.nom_departement
            );

            const trace = {
                x: hospitalByDepartment.map(d => d[0]),
                y: hospitalByDepartment.map(d => d[1]),
                type: 'bar'
            };

            Plotly.newPlot('hospitalByDepartment', [trace], {
                title: 'Hospitalisations par D√©partement'
            });
        }

        renderPathologyAnalysis(data) {
            const topPathologies = d3.rollups(
                data,
                v => d3.sum(v, d => +d.nbr_hospi),
                d => d.nom_pathologie
            ).sort((a, b) => b[1] - a[1]).slice(0, 10);

            const trace = {
                x: topPathologies.map(d => d[0]),
                y: topPathologies.map(d => d[1]),
                type: 'bar'
            };

            Plotly.newPlot('topPathologies', [trace], {
                title: 'Top 10 Pathologies'
            });
        }

        renderDemographicAnalysis(data) {
            // Implement demographic analysis rendering
            // This would depend on the exact structure of your demographics data
        }
    }

    // Initialize dashboard
    const dashboard = new HospitalDashboard();
    </script>
</body>
</html>
